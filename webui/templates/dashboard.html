{% extends "base.html" %} {% block content %}
<div class="container">
  <h1>DJ Library ‚Äî Dashboard</h1>

  {% if msg %}
  <div class="flash">{{ msg }}</div>
  {% endif %}

  <section class="card">
    <h3>Przep≈Çyw: 1) Unsorted ‚Üí 2) Analiza ‚Üí 3) Akceptuj i przenie≈õ</h3>
    <div class="row" style="justify-content: space-between">
      <div>
        <div><strong>Biblioteka:</strong> {{ stats.lib_root }}</div>
        <div><strong>Inbox:</strong> {{ stats.inbox }}</div>
        <div>
          <strong>CSV:</strong> {{ stats.csv_path }} ‚Ä¢ wierszy: {{
          stats.csv_rows }}
        </div>
      </div>
    </div>
  </section>

  <!-- Krok 1: UNSORTED ‚Üí Scan -->
  <section class="card">
    <div class="row" style="justify-content: space-between; align-items: center">
      <h3 style="margin:0">Krok 1 ‚Äî Za≈Çaduj UNSORTED</h3>
      <form method="post" action="/action/scan" style="display:inline">
        <button>‚ñ∂Ô∏é Skanuj INBOX</button>
      </form>
    </div>
    {% if scan and (scan.state=='running' or scan.state=='done') %} {% set total
    = scan.total or 0 %} {% set processed = scan.processed or 0 %} {% set
    percent = (processed * 100 // (total or 1)) %}
    <div class="row">
      <div class="progress" aria-label="Postƒôp skanowania">
        <div class="bar" data-pct="{{ percent }}"></div>
      </div>
    </div>
    <div class="row" style="justify-content: space-between">
      <small class="muted">{{ processed }}/{{ total }} ({{ percent }}%)</small>
      <small class="muted"
        >{{ 'Zako≈Ñczono' if scan.state=='done' else 'W toku' }}</small
      >
    </div>
    {% if scan.last_file %}
    <div class="row">
      <small class="muted">Ostatni plik: {{ scan.last_file }}</small>
    </div>
    {% endif %} {% if scan.missing_fpcalc %}
    <div class="flash">
      Brakowa≈Ço fpcalc ‚Äî pr√≥bowali≈õmy zainstalowaƒá automatycznie. Skan
      kontynuuje bez fingerprintu tam gdzie to konieczne.
    </div>
    {% endif %}
    <script>
      (function () {
        const bar = document.querySelector(".progress .bar");
        const wrap = document.currentScript.closest("section");
        const smalls = wrap ? wrap.querySelectorAll("small.muted") : [];
        function update(j) {
          const pct = Math.floor(((j.processed || 0) * 100) / (j.total || 1));
          if (bar) bar.style.width = pct + "%";
          // zaktualizuj liczby i status (done/running)
          if (smalls && smalls.length >= 2) {
            smalls[0].textContent = `${j.processed || 0}/${j.total || 0} (${pct}%)`;
            smalls[1].textContent = j.state === "done" ? "Zako≈Ñczono" : "W toku";
          }
        }
        function poll() {
          fetch("/api/scan-status")
            .then((r) => r.json())
            .then((j) => {
              if (!j || j.state === "idle") return;
              update(j);
              if (j.state === "running") setTimeout(poll, 1500);
            })
            .catch(() => {});
        }
        // inicjalne ustawienie szeroko≈õci paska
        if (bar && bar.dataset.pct) bar.style.width = bar.dataset.pct + "%";
        setTimeout(poll, 1200);
      })();
    </script>
    {% else %}
    <p class="muted">Brak aktywnego skanowania.</p>
    {% endif %}
  </section>

  <!-- Krok 2: Analiza (AcoustID + gatunki z Last.fm/Spotify) -->
  <section class="card">
    <div class="row" style="justify-content: space-between; align-items: center">
      <h3 style="margin:0">Krok 2 ‚Äî Analiza</h3>
      <form method="post" action="/action/enrich-online" style="display:inline">
  <button title="AcoustID + MusicBrainz + gatunki z Last.fm/Spotify">üîé Analizuj teraz</button>
      </form>
    </div>
    {% if enrich and (enrich.state=='running' or enrich.state=='done') %} {% set
    total = enrich.total or 0 %} {% set processed = enrich.processed or 0 %} {%
    set updated = enrich.updated or 0 %} {% set percent = (processed * 100 //
    (total or 1)) %}
    <div class="row">
      <div class="progress" aria-label="Postƒôp wzbogacania">
        <div class="bar" id="enrich-bar" data-pct="{{ percent }}"></div>
      </div>
    </div>
    <div class="row" style="justify-content: space-between">
      <small class="muted"
        >{{ processed }}/{{ total }} ({{ percent }}%) ‚Ä¢ updated: {{ updated
        }}</small
      >
      <small class="muted"
        >{{ 'Zako≈Ñczono' if enrich.state=='done' else 'W toku' }}</small
      >
    </div>
    {% if enrich.last_file %}
    <div class="row">
      <small class="muted">Ostatni plik: {{ enrich.last_file }}</small>
    </div>
    {% endif %}
    <script>
      (function () {
        const bar = document.getElementById("enrich-bar");
        const wrap = document.currentScript.closest("section");
        const smalls = wrap ? wrap.querySelectorAll("small.muted") : [];
        if (bar && bar.dataset.pct) {
          bar.style.width = bar.dataset.pct + "%";
        }
        // Poll co 2s; je≈õli running, od≈õwie≈º pasek, liczby i tabelƒô pending
        function poll() {
          fetch("/api/enrich-status")
            .then((r) => r.json())
            .then((j) => {
              if (!j || j.state === "idle") return;
              const pct = Math.floor(
                ((j.processed || 0) * 100) / (j.total || 1)
              );
              if (bar) bar.style.width = pct + "%";
              if (smalls && smalls.length >= 2) {
                smalls[0].textContent = `${j.processed || 0}/${j.total || 0} (${pct}%) ‚Ä¢ updated: ${j.updated || 0}`;
                smalls[1].textContent = j.state === "done" ? "Zako≈Ñczono" : "W toku";
              }
              // gdy trwa ‚Äî od≈õwie≈º pending co ka≈ºde wywo≈Çanie; gdy sko≈Ñczy ‚Äî jednorazowo
              if (j.state === "running") {
                if (window.loadPending) window.loadPending();
                setTimeout(poll, 2000);
              } else if (j.state === "done") {
                if (window.loadPending) window.loadPending();
              }
            })
            .catch(() => {});
        }
        setTimeout(poll, 1500);
      })();
    </script>
    {% else %}
    <p class="muted">Brak aktywnego procesu wzbogacania.</p>
    {% endif %}
  </section>

  <!-- Uzupe≈Çnianie fingerprint√≥w (opcjonalnie, gdy brakowa≈Ço) -->
  <section class="card">
    <div class="row" style="justify-content: space-between; align-items: center">
      <h3 style="margin:0">Fingerprinty (opcjonalnie)</h3>
      <form method="post" action="/action/fix-fingerprints" style="display:inline">
        <button class="secondary" title="Uzupe≈Çnij fingerprinty dla brakujƒÖcych">üß© Uzupe≈Çnij fingerprinty</button>
      </form>
    </div>
    {% if fp and (fp.state=='running' or fp.state=='done') %} {% set total =
    fp.total or 0 %} {% set processed = fp.processed or 0 %} {% set updated =
    fp.updated or 0 %} {% set percent = (processed * 100 // (total or 1)) %}
    <div class="row">
      <div class="progress" aria-label="Postƒôp uzupe≈Çniania fingerprint√≥w">
        <div class="bar" id="fp-bar" data-pct="{{ percent }}"></div>
      </div>
    </div>
    <div class="row" style="justify-content: space-between">
      <small class="muted"
        >{{ processed }}/{{ total }} ({{ percent }}%) ‚Ä¢ updated: {{ updated
        }}</small
      >
      <small class="muted"
        >{{ 'Zako≈Ñczono' if fp.state=='done' else 'W toku' }}</small
      >
    </div>
    {% if fp.last_file %}
    <div class="row">
      <small class="muted">Ostatni plik: {{ fp.last_file }}</small>
    </div>
    {% endif %}
    <script>
      (function () {
        const bar = document.getElementById("fp-bar");
        const wrap = document.currentScript.closest("section");
        const smalls = wrap ? wrap.querySelectorAll("small.muted") : [];
        if (bar && bar.dataset.pct) {
          bar.style.width = bar.dataset.pct + "%";
        }
        function pollFP() {
          fetch("/api/fingerprint-status")
            .then((r) => r.json())
            .then((j) => {
              if (!j || j.state === "idle") return;
              const pct = Math.floor(
                ((j.processed || 0) * 100) / (j.total || 1)
              );
              if (bar) bar.style.width = pct + "%";
              if (smalls && smalls.length >= 2) {
                smalls[0].textContent = `${j.processed || 0}/${j.total || 0} (${pct}%) ‚Ä¢ updated: ${j.updated || 0}`;
                smalls[1].textContent = j.state === "done" ? "Zako≈Ñczono" : "W toku";
              }
              if (j.state === "running") setTimeout(pollFP, 2000);
            })
            .catch(() => {});
        }
        setTimeout(pollFP, 1500);
      })();
    </script>
    {% else %}
    <p class="muted">Brak aktywnego procesu uzupe≈Çniania fingerprint√≥w.</p>
    {% endif %}
  </section>

  <!-- Krok 3: Akceptuj i przenie≈õ (po akceptacji pliki sƒÖ automatycznie przenoszone) -->
  <section class="card">
    <div class="row" style="justify-content: space-between; align-items: center">
      <h3 style="margin:0">Krok 3 ‚Äî Akceptuj tagi i przenie≈õ</h3>
      <button type="button" class="secondary" onclick="checkFpcalc()" title="Sprawd≈∫ fpcalc: wykryta ≈õcie≈ºka i wersja">üõ†Ô∏è Check fpcalc</button>
    </div>

  <section class="card">
    <h3>Nowe utwory do akceptacji</h3>
    <div
      id="fpcalc-box"
      class="muted"
      style="margin-bottom: 8px; display: none"
    ></div>
    <div id="review-table" class="row" style="display: block; overflow: auto">
      <div class="muted">≈Åadowanie‚Ä¶</div>
    </div>
    <script>
      (function () {
        function esc(s) {
          return (s || "")
            .toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
        }
        function input(name, val) {
          return `<input type="text" name="${name}" value="${esc(
            val
          )}" style="width: 140px;"/>`;
        }
        function rowHtml(it) {
          const id = esc(it.track_id);
          return `<tr>
            <td><input type="checkbox" name="ids" value="${id}"/></td>
            <td>${esc(it.file_name)}</td>
            <td>${input(`artist_${id}`, it.artist)}</td>
            <td>${input(`title_${id}`, it.title)}</td>
            <td>${input(`version_${id}`, it.version)}</td>
            <td>${input(`genre_${id}`, it.genre)}</td>
            <td>${input(`album_${id}`, it.album)}</td>
            <td>${input(`year_${id}`, it.year)}</td>
            <td>${esc(it.duration)}</td>
            <td>${esc(it.bpm)}</td>
            <td>${esc(it.key)}</td>
            <td><small class="muted">${esc(it.source || "")}</small></td>
          </tr>`;
        }
        function renderPending(items) {
          const mount = document.getElementById("review-table");
          if (!items.length) {
            mount.innerHTML =
              '<div class="muted">Brak pozycji do akceptacji.</div>';
            return;
          }
          const head = `<thead><tr>
            <th><input type="checkbox" id="sel-all"/></th>
            <th>Plik</th><th>Artysta</th><th>Tytu≈Ç</th><th>Wersja</th>
            <th>Gatunek</th><th>Album</th><th>Rok</th><th>Czas</th>
            <th>BPM</th><th>Key</th><th>≈πr√≥d≈Ço</th>
          </tr></thead>`;
          const rows = items.slice(0, 200).map(rowHtml).join("");
          // Po akceptacji backend automatycznie uruchomi przenoszenie
          mount.innerHTML = `<form method="post" action="/review/accept-batch"><div style="max-height:50vh; overflow:auto"><table>${head}<tbody>${rows}</tbody></table></div><div class="actions" style="margin-top:8px;"><button>‚úÖ Akceptuj i przenie≈õ zaznaczone</button></div></form>`;
          const selAll = document.getElementById("sel-all");
          if (selAll) {
            selAll.addEventListener("change", () => {
              mount
                .querySelectorAll("input[type=checkbox][name=ids]")
                .forEach((cb) => (cb.checked = selAll.checked));
            });
          }
        }
        function loadPending() {
          fetch("/api/pending-tracks")
            .then((r) => r.json())
            .then((j) => {
              renderPending((j && j.items) || []);
            })
            .catch(() => {
              const mount = document.getElementById("review-table");
              mount.innerHTML =
                '<div class="muted">Nie uda≈Ço siƒô wczytaƒá listy.</div>';
            });
        }
        window.loadPending = loadPending;
        window.checkFpcalc = function () {
          const box = document.getElementById("fpcalc-box");
          if (box) {
            box.style.display = "block";
            box.textContent = "Sprawdzanie fpcalc‚Ä¶";
          }
          fetch("/api/fpcalc-status")
            .then((r) => r.json())
            .then((j) => {
              if (!box) return;
              if (j.ok) {
                const v =
                  (j.version || "").trim() || "(brak informacji o wersji)";
                box.innerHTML = `<div><strong>fpcalc</strong>: ${v}<br/><code>${
                  j.path || ""
                }</code></div>`;
              } else {
                box.innerHTML = `<div class="flash">Nie uda≈Ço siƒô: ${String(
                  j.error || ""
                ).replaceAll("<", "&lt;")}</div>`;
              }
            })
            .catch((e) => {
              if (box)
                box.innerHTML = `<div class="flash">B≈ÇƒÖd sprawdzania fpcalc</div>`;
            });
        };
        loadPending();
      })();
    </script>
  </section>

  <section class="card">
    <h3>Nawigacja</h3>
    <div class="actions">
      <a class="secondary" href="/taxonomy">Taksonomia</a>
      <a class="secondary" href="/csv">PodglƒÖd CSV</a>
      <a class="secondary" href="/wizard">Setup Wizard</a>
    </div>
  </section>
</div>
{% endblock %}
