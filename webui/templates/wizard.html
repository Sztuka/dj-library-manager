{% extends "base.html" %} {% block content %}
<div class="container">
  <h1>Setup Wizard</h1>

  {% if msg %}
  <div class="flash">{{ msg }}</div>
  {% endif %}

  <div class="steps">
    <div class="step {{ 'active' if step==1 else '' }}">1. Lokalizacja</div>
    <div class="step {{ 'active' if step==2 else '' }}">2. Taksonomia</div>
    <div class="step {{ 'active' if step==3 else '' }}">3. Foldery & Skan</div>
  </div>

  {# STEP 1 #} {% if step == 1 %}
  <form method="post" action="/wizard/step1" class="card">
    <label>LIB ROOT (gdzie powstanie „READY TO PLAY” i „REVIEW QUEUE”)</label>
    <div class="row">
      <input
        type="text"
        name="lib_root"
        value="{{ cfg.LIB_ROOT or '' }}"
        placeholder="/Volumes/Music/Library"
      />
      <button type="button" onclick="pick('lib_root')">Wybierz…</button>
    </div>

    <label>INBOX_UNSORTED (źródło plików do uporządkowania)</label>
    <div class="row">
      <input
        type="text"
        name="inbox_unsorted"
        value="{{ cfg.INBOX_UNSORTED or '' }}"
        placeholder="/Volumes/Music/INBOX_UNSORTED"
      />
      <button type="button" onclick="pick('inbox_unsorted')">Wybierz…</button>
    </div>

    <div class="actions">
      <button type="submit">Zapisz i dalej →</button>
    </div>
  </form>
  {% endif %} {# STEP 2 #} {% if step == 2 %}
  <form method="post" action="/wizard/step2" class="card">
    <div
      class="row"
      style="
        justify-content: flex-end;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      "
    >
      <small class="muted"
        >Zastosuj preferowany styl:
        <code>{{ (prefs.label_style or 'as_is')|upper }}</code></small
      >
      <button
        type="button"
        class="secondary"
        onclick="window.location.reload()"
      >
        Odśwież
      </button>
    </div>
    <h3>CLUB — subkategorie</h3>
    <div id="club">
      {% for name in club %}
      <div class="row">
        <input type="text" name="club" value="{{ name }}" />
        <button type="button" onclick="this.parentElement.remove()">
          Usuń
        </button>
      </div>
      {% endfor %}
      <div class="row">
        <button type="button" onclick="addRow('club')">+ Dodaj</button>
      </div>
      {% if sugg_club %}
      <div class="chips" style="margin-top: 0.5rem">
        {% for s in sugg_club %}
        <button
          type="button"
          class="chip"
          data-section="club"
          data-value="{{ s }}"
          onclick="chipToInput(this)"
        >
          + {{ s }}
        </button>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <h3>OPEN FORMAT — subkategorie</h3>
    <div id="openf">
      {% for name in openf %}
      <div class="row">
        <input type="text" name="openf" value="{{ name }}" />
        <button type="button" onclick="this.parentElement.remove()">
          Usuń
        </button>
      </div>
      {% endfor %}
      <div class="row">
        <button type="button" onclick="addRow('openf')">+ Dodaj</button>
      </div>
      {% if sugg_open %}
      <div class="chips" style="margin-top: 0.5rem">
        {% for s in sugg_open %}
        <button
          type="button"
          class="chip"
          data-section="openf"
          data-value="{{ s }}"
          onclick="chipToInput(this)"
        >
          + {{ s }}
        </button>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <p>
      <strong>MIXES</strong> — top-level kubełek (dodawany zawsze, bez
      subfolderów).
    </p>

    <div class="row">
      <label class="check">
        <input type="checkbox" name="apply_style" value="1" />
        <span
          >Zastosuj preferowany styl (<code>{{ prefs.label_style }}</code
          >)</span
        >
      </label>
    </div>

    <div class="actions">
      <a class="secondary" href="/wizard?step=1">← Wstecz</a>
      <button type="submit">Zapisz i dalej →</button>
    </div>
  </form>
  {% endif %} {# STEP 3 #} {% if step == 3 %}
  <form method="post" action="/wizard/step3" class="card">
    <p>
      Utworzymy strukturę folderów wg taksonomii. Możesz też od razu zeskanować
      wybrany wcześniej folder z INBOX_UNSORTED.
    </p>
    <label class="row">
      <input type="checkbox" name="run_scan" value="1" />
      <span>Od razu zeskanuj wybrany wcześniej folder</span>
    </label>
    <div class="actions">
      <a class="secondary" href="/wizard?step=2">← Wstecz</a>
      <button type="submit">Utwórz foldery</button>
    </div>
  </form>
  {% endif %}
</div>

<script>
  async function pick(field) {
    const input = document.querySelector(`input[name="${field}"]`);
    try {
      const r = await fetch("/api/pick?target=" + encodeURIComponent(field));
      const j = await r.json();
      if (j.ok && j.path) {
        input.value = j.path;
        return;
      }
    } catch (e) {
      /* no-op */
    }
    // Łagodne zachowanie gdy picker nie działa: fokus na polu, bez modala
    input.focus();
  }
  function addRow(section, initialValue = "") {
    const box = document.getElementById(section);
    const row = document.createElement("div");
    row.className = "row";
    const esc = (s) =>
      String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
    row.innerHTML = `<input type="text" name="${section}" value="${esc(
      initialValue
    )}"/> <button type="button" onclick="this.parentElement.remove()">Usuń</button>`;
    box.insertBefore(row, box.lastElementChild);
  }
  function chipToInput(el) {
    const section = el.dataset.section;
    const value = el.dataset.value || "";
    addRow(section, value);
    el.remove();
  }
</script>
{% endblock %}
